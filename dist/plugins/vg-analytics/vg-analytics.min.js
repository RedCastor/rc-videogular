"use strict";angular.module("com.2fdevs.videogular.plugins.analytics",["angulartics"]).directive("vgAnalytics",["$analytics","VG_STATES",function(r,c){return{restrict:"E",require:"^videogular",scope:{vgTrackInfo:"=?"},link:function(o,e,n,t){var a=null,f=null,s=[];o.API=t,o.trackEvent=function(e){r.eventTrack(e,a)},o.onPlayerReady=function(e){e&&o.trackEvent("ready")},o.onChangeState=function(e){switch(e){case c.PLAY:o.vgTrackInfo.events.play&&(o.setValue(o.vgTrackInfo.events.play),o.trackEvent("play"));break;case c.PAUSE:o.vgTrackInfo.events.pause&&(o.setValue(o.vgTrackInfo.events.pause),o.trackEvent("pause"));break;case c.STOP:o.vgTrackInfo.events.stop&&(o.setValue(o.vgTrackInfo.events.stop),o.trackEvent("stop"))}},o.onCompleteVideo=function(e){e&&o.trackEvent("complete")},o.onUpdateTime=function(e){0<s.length&&e>=s[0].jump&&(o.trackEvent("progress "+s[0].percent+"%"),s.shift())},o.updateTrackInfo=function(e){o.vgTrackInfo.category&&(a.category=o.vgTrackInfo.category),o.vgTrackInfo.label&&(a.label=o.vgTrackInfo.label)},o.setValue=function(e){e&&("percent"===e?1e3<t.totalTime?a.value=Math.floor(t.currentTime/t.totalTime*100):a.value=0:"time"===e&&(a.value=Math.floor(t.currentTime/1e3)))},o.addWatchers=function(){if((o.vgTrackInfo.category||o.vgTrackInfo.label)&&(a={},o.updateTrackInfo(o.vgTrackInfo)),o.$watch("vgTrackInfo",o.updateTrackInfo,!0),o.vgTrackInfo.events.ready&&o.$watch(function(){return t.isReady},function(e,n){o.onPlayerReady(e)}),(o.vgTrackInfo.events.play||o.vgTrackInfo.events.pause||o.vgTrackInfo.events.stop)&&o.$watch(function(){return t.currentState},function(e,n){e!==n&&o.onChangeState(e)}),o.vgTrackInfo.events.complete&&o.$watch(function(){return t.isCompleted},function(e,n){o.onCompleteVideo(e)}),o.vgTrackInfo.events.progress){o.$watch(function(){return t.currentTime},function(e,n){o.onUpdateTime(e/1e3)});var c=o.$watch(function(){return t.totalTime},function(e,n){if(0<(f=e/1e3)){for(var t=o.vgTrackInfo.events.progress-1,a=Math.floor(f*o.vgTrackInfo.events.progress/100),r=0;r<t;r++)s.push({percent:(r+1)*o.vgTrackInfo.events.progress,jump:(r+1)*a});c()}})}},t.isConfig?o.$watch("API.config",function(){o.API.config&&(o.vgTrackInfo=o.API.config.plugins.analytics,o.addWatchers())}):o.addWatchers()}}}]);