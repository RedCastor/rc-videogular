"use strict";angular.module("com.2fdevs.videogular.plugins.imaads",[]).directive("vgImaAds",["$window","VG_STATES",function(e,n){return{restrict:"E",require:"^videogular",scope:{vgNetwork:"=?",vgUnitPath:"=?",vgCompanion:"=?",vgCompanionSize:"=?",vgAdTagUrl:"=?",vgSkipButton:"=?"},link:function(t,o,i,a){var d,s,g=new google.ima.AdDisplayContainer(o[0]),l=new google.ima.AdsLoader(g),r=null,u=!1,p=function(){l.contentComplete()},A=angular.element(t.vgSkipButton);t.API=a,t.onPlayerReady=function(e){e&&(a.mediaElement[0].addEventListener("ended",p),l.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,t.onAdsManagerLoaded,!1,this),l.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,t.onAdError,!1,this),t.loadAds())},t.onUpdateAds=function(e,n){e!==n&&(t.loadAds(),a.pause(),g.initialize(),t.requestAds(t.vgAdTagUrl))},t.loadAds=function(){t.vgCompanion&&googletag.cmd.push(function(){googletag.defineSlot("/"+t.vgNetwork+"/"+t.vgUnitPath,t.vgCompanionSize,t.vgCompanion).addService(googletag.companionAds()).addService(googletag.pubads()),googletag.companionAds().setRefreshUnfilledSlots(!0),googletag.pubads().enableVideoAds(),googletag.enableServices()})},t.onUpdateState=function(e){switch(e){case n.PLAY:u||(a.pause(),g.initialize(),t.requestAds(t.vgAdTagUrl),u=!0);break;case n.STOP:l.contentComplete()}},t.requestAds=function(n){t.show();var i=new google.ima.AdsRequest,a=e.getComputedStyle(o[0]);i.adTagUrl=n,i.linearAdSlotWidth=parseInt(a.width,10),i.linearAdSlotHeight=parseInt(a.height,10),i.nonLinearAdSlotWidth=parseInt(a.width,10),i.nonLinearAdSlotHeight=parseInt(a.height,10),l.requestAds(i)},t.onAdsManagerLoaded=function(e){t.show(),r=e.getAdsManager(a.mediaElement[0]),t.processAdsManager(r)},t.processAdsManager=function(e){d=a.videogularElement[0].offsetWidth,s=a.videogularElement[0].offsetHeight,e.addEventListener(google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,t.onContentPauseRequested,!1,this),e.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,t.onContentResumeRequested,!1,this),e.addEventListener(google.ima.AdEvent.Type.SKIPPABLE_STATE_CHANGED,t.onSkippableStateChanged,!1,this),e.addEventListener(google.ima.AdEvent.Type.ALL_ADS_COMPLETED,t.onAllAdsComplete,!1,this),e.addEventListener(google.ima.AdEvent.Type.COMPLETE,t.onAdComplete,!1,this),e.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,t.onAdError,!1,this),e.init(d,s,google.ima.ViewMode.NORMAL),e.start()},t.onSkippableStateChanged=function(){r.getAdSkippableState()?A.css("display","block"):A.css("display","none")},t.onClickSkip=function(){r.skip()},t.onContentPauseRequested=function(){t.show(),a.mediaElement[0].removeEventListener("ended",p),a.pause()},t.onContentResumeRequested=function(){a.mediaElement[0].addEventListener("ended",p),a.play(),t.hide()},t.onAdError=function(){r&&r.destroy(),t.hide(),a.play()},t.onAllAdsComplete=function(){t.hide(),r.getCuePoints().join().indexOf("-1")>=0&&a.stop()},t.onAdComplete=function(){0},t.show=function(){o.css("display","block")},t.hide=function(){o.css("display","none")},A.bind("click",t.onClickSkip),o.prepend(A),angular.element(e).bind("resize",function(){d=a.videogularElement[0].offsetWidth,s=a.videogularElement[0].offsetHeight,r&&(a.isFullScreen?r.resize(d,s,google.ima.ViewMode.FULLSCREEN):r.resize(d,s,google.ima.ViewMode.NORMAL))}),a.isConfig?t.$watch("API.config",function(){t.API.config&&(t.vgNetwork=t.API.config.plugins["ima-ads"].network,t.vgUnitPath=t.API.config.plugins["ima-ads"].unitPath,t.vgCompanion=t.API.config.plugins["ima-ads"].companion,t.vgCompanionSize=t.API.config.plugins["ima-ads"].companionSize,t.vgAdTagUrl=t.API.config.plugins["ima-ads"].adTagUrl,t.vgSkipButton=t.API.config.plugins["ima-ads"].skipButton,t.onPlayerReady(!0))}):t.$watch("vgAdTagUrl",t.onUpdateAds.bind(t)),t.$watch(function(){return a.isReady},function(e,n){!0!==a.isReady&&e===n||t.onPlayerReady(e)}),t.$watch(function(){return a.currentState},function(e,n){e!==n&&t.onUpdateState(e)})}}}]);