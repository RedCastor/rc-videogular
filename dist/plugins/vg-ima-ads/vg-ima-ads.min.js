"use strict";angular.module("com.2fdevs.videogular.plugins.imaads",[]).directive("vgImaAds",["$window","VG_STATES",function(p,A){return{restrict:"E",require:"^videogular",scope:{vgNetwork:"=?",vgUnitPath:"=?",vgCompanion:"=?",vgCompanionSize:"=?",vgAdTagUrl:"=?",vgSkipButton:"=?"},link:function(o,i,e,t){var n,a,d=new google.ima.AdDisplayContainer(i[0]),s=new google.ima.AdsLoader(d),g=null,l=!1,r=function(){s.contentComplete()},u=angular.element(o.vgSkipButton);o.API=t,o.onPlayerReady=function(e){e&&(t.mediaElement[0].addEventListener("ended",r),s.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,o.onAdsManagerLoaded,!1,this),s.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,o.onAdError,!1,this),o.loadAds())},o.onUpdateAds=function(e,n){e!==n&&(o.loadAds(),t.pause(),d.initialize(),o.requestAds(o.vgAdTagUrl))},o.loadAds=function(){o.vgCompanion&&googletag.cmd.push(function(){googletag.defineSlot("/"+o.vgNetwork+"/"+o.vgUnitPath,o.vgCompanionSize,o.vgCompanion).addService(googletag.companionAds()).addService(googletag.pubads()),googletag.companionAds().setRefreshUnfilledSlots(!0),googletag.pubads().enableVideoAds(),googletag.enableServices()})},o.onUpdateState=function(e){switch(e){case A.PLAY:l||(t.pause(),d.initialize(),o.requestAds(o.vgAdTagUrl),l=!0);break;case A.STOP:s.contentComplete()}},o.requestAds=function(e){o.show();var n=new google.ima.AdsRequest,t=p.getComputedStyle(i[0]);n.adTagUrl=e,n.linearAdSlotWidth=parseInt(t.width,10),n.linearAdSlotHeight=parseInt(t.height,10),n.nonLinearAdSlotWidth=parseInt(t.width,10),n.nonLinearAdSlotHeight=parseInt(t.height,10),s.requestAds(n)},o.onAdsManagerLoaded=function(e){o.show(),g=e.getAdsManager(t.mediaElement[0]),o.processAdsManager(g)},o.processAdsManager=function(e){n=t.videogularElement[0].offsetWidth,a=t.videogularElement[0].offsetHeight,e.addEventListener(google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,o.onContentPauseRequested,!1,this),e.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,o.onContentResumeRequested,!1,this),e.addEventListener(google.ima.AdEvent.Type.SKIPPABLE_STATE_CHANGED,o.onSkippableStateChanged,!1,this),e.addEventListener(google.ima.AdEvent.Type.ALL_ADS_COMPLETED,o.onAllAdsComplete,!1,this),e.addEventListener(google.ima.AdEvent.Type.COMPLETE,o.onAdComplete,!1,this),e.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,o.onAdError,!1,this),e.init(n,a,google.ima.ViewMode.NORMAL),e.start()},o.onSkippableStateChanged=function(){g.getAdSkippableState()?u.css("display","block"):u.css("display","none")},o.onClickSkip=function(){g.skip()},o.onContentPauseRequested=function(){o.show(),t.mediaElement[0].removeEventListener("ended",r),t.pause()},o.onContentResumeRequested=function(){t.mediaElement[0].addEventListener("ended",r),t.play(),o.hide()},o.onAdError=function(){g&&g.destroy(),o.hide(),t.play()},o.onAllAdsComplete=function(){o.hide(),0<=g.getCuePoints().join().indexOf("-1")&&t.stop()},o.onAdComplete=function(){0},o.show=function(){i.css("display","block")},o.hide=function(){i.css("display","none")},u.bind("click",o.onClickSkip),i.prepend(u),angular.element(p).bind("resize",function(){n=t.videogularElement[0].offsetWidth,a=t.videogularElement[0].offsetHeight,g&&(t.isFullScreen?g.resize(n,a,google.ima.ViewMode.FULLSCREEN):g.resize(n,a,google.ima.ViewMode.NORMAL))}),t.isConfig?o.$watch("API.config",function(){o.API.config&&(o.vgNetwork=o.API.config.plugins["ima-ads"].network,o.vgUnitPath=o.API.config.plugins["ima-ads"].unitPath,o.vgCompanion=o.API.config.plugins["ima-ads"].companion,o.vgCompanionSize=o.API.config.plugins["ima-ads"].companionSize,o.vgAdTagUrl=o.API.config.plugins["ima-ads"].adTagUrl,o.vgSkipButton=o.API.config.plugins["ima-ads"].skipButton,o.onPlayerReady(!0))}):o.$watch("vgAdTagUrl",o.onUpdateAds.bind(o)),o.$watch(function(){return t.isReady},function(e,n){!0!==t.isReady&&e===n||o.onPlayerReady(e)}),o.$watch(function(){return t.currentState},function(e,n){e!==n&&o.onUpdateState(e)})}}}]);